name: PR å»ºç½®

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    name: å»ºæ§‹ VSIX
    runs-on: ubuntu-latest

    steps:
      - name: ç°½å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£ç›¸ä¾å¥—ä»¶
        run: npm ci

      - name: å»ºæ§‹å°ˆæ¡ˆ
        run: npm run esbuild

      - name: è®€å–ç‰ˆæœ¬
        id: package_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: æ‰“åŒ…æ“´å……åŠŸèƒ½
        run: npx -y @vscode/vsce package --baseImagesUrl https://raw.githubusercontent.com/doggy8088/vscode-pangu/main/ --allow-star-activation

      - name: ä¸Šå‚³ VSIX æª”æ¡ˆ
        uses: actions/upload-artifact@v4
        with:
          name: pangu2-${{ steps.package_version.outputs.version }}-pr${{ github.event.pull_request.number }}
          path: pangu2-${{ steps.package_version.outputs.version }}.vsix
          retention-days: 30

      - name: åœ¨ PR ç•™è¨€
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const version = '${{ steps.package_version.outputs.version }}';
            const runId = '${{ github.run_id }}';
            const prNumber = context.issue.number;
            const repo = context.repo;
            
            // å–å¾— VSIX æª”æ¡ˆå¤§å°
            const vsixFile = `pangu2-${version}.vsix`;
            let fileSize = 'N/A';
            try {
              const stats = fs.statSync(vsixFile);
              const fileSizeInBytes = stats.size;
              const fileSizeInKB = (fileSizeInBytes / 1024).toFixed(2);
              const fileSizeInMB = (fileSizeInBytes / (1024 * 1024)).toFixed(2);
              fileSize = parseFloat(fileSizeInMB) > 1 ? `${fileSizeInMB} MB` : `${fileSizeInKB} KB`;
            } catch (error) {
              console.log('ç„¡æ³•å–å¾—æª”æ¡ˆå¤§å°:', error);
            }

            const actionUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}`;
            const artifactUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}#artifacts`;

            const commentBody = `## ðŸŽ‰ å»ºç½®æˆåŠŸï¼
            
            **ç‰ˆæœ¬ï¼š** \`${version}\`
            **æª”æ¡ˆå¤§å°ï¼š** ${fileSize}
            
            ### ðŸ“¦ ä¸‹è¼‰ VSIX æª”æ¡ˆ
            
            è«‹å‰å¾€ [Artifacts ä¸‹è¼‰é é¢](${artifactUrl}) ä¸‹è¼‰ \`pangu2-${version}-pr${prNumber}\`
            
            ### ðŸ”— ç›¸é—œé€£çµ
            
            - [æŸ¥çœ‹å»ºç½®è©³æƒ…](${actionUrl})
            - [ä¸‹è¼‰é é¢](${artifactUrl})
            
            ### ðŸ“ å®‰è£èªªæ˜Ž
            
            ä¸‹è¼‰ VSIX æª”æ¡ˆå¾Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å®‰è£ï¼š
            
            1. **é€éŽ VS Code ä»‹é¢ï¼š**
               - é–‹å•Ÿ VS Code
               - å‰å¾€æ“´å……åŠŸèƒ½é é¢ (Ctrl+Shift+X æˆ– Cmd+Shift+X)
               - é»žé¸å³ä¸Šè§’çš„ã€Œ...ã€é¸å–®
               - é¸æ“‡ã€Œå¾ž VSIX å®‰è£...ã€
               - é¸å–ä¸‹è¼‰çš„ VSIX æª”æ¡ˆ
            
            2. **é€éŽå‘½ä»¤åˆ—ï¼š**
               \`\`\`bash
               code --install-extension pangu2-${version}.vsix
               \`\`\`
            
            ---
            *æ­¤å»ºç½®ç”± GitHub Actions è‡ªå‹•ç”¢ç”Ÿ*`;

            // æª¢æŸ¥æ˜¯å¦å·²æœ‰æ­¤ workflow çš„ç•™è¨€
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸŽ‰ å»ºç½®æˆåŠŸï¼')
            );

            if (botComment) {
              // æ›´æ–°ç¾æœ‰ç•™è¨€
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('å·²æ›´æ–°ç¾æœ‰ç•™è¨€');
            } else {
              // å»ºç«‹æ–°ç•™è¨€
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('å·²å»ºç«‹æ–°ç•™è¨€');
            }

      - name: å»ºç½®æ‘˜è¦
        run: |
          echo "### âœ… å»ºç½®å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬ï¼š** ${{ steps.package_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**VSIX æª”æ¡ˆå·²ä¸Šå‚³ç‚º Artifactï¼Œè«‹å‰å¾€ [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts) ä¸‹è¼‰**" >> $GITHUB_STEP_SUMMARY
