name: è‡ªå‹•ç™¼å¸ƒ VS Code æ“´å……å¥—ä»¶

on:
  push:
    branches: [ main ]
    paths:
      - 'package.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-version:
    name: æª¢æŸ¥ç‰ˆæœ¬è®Šæ›´
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.version_check.outputs.should_release }}
      version: ${{ steps.package_version.outputs.version }}
      tag-exists: ${{ steps.check_tag.outputs.exists }}

    steps:
      - name: ç°½å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: è®€å–ç‰ˆæœ¬
        id: package_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: æª¢æŸ¥æ¨™ç±¤æ˜¯å¦å·²å­˜åœ¨
        id: check_tag
        run: |
          TAG_NAME="v${{ steps.package_version.outputs.version }}"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag $TAG_NAME already exists, skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag $TAG_NAME does not exist, proceeding with release"
          fi

      - name: æª¢æŸ¥ç‰ˆæœ¬æ˜¯å¦è®Šæ›´
        id: version_check
        run: |
          # å¦‚æœæ˜¯æ‰‹å‹•è§¸ç™¼ï¼Œç›´æ¥ç™¼å¸ƒ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Manual workflow dispatch - will release"
            exit 0
          fi

          # æª¢æŸ¥ package.json æ˜¯å¦åœ¨æœ€æ–° commit ä¸­è¢«ä¿®æ”¹
          if git diff HEAD^ HEAD --name-only | grep -q "^package.json$"; then
            # æª¢æŸ¥ç‰ˆæœ¬è™Ÿæ˜¯å¦è®Šæ›´
            OLD_VERSION=$(git show HEAD^:package.json | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf-8')).version" || echo "")
            NEW_VERSION="${{ steps.package_version.outputs.version }}"

            if [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "âœ… Version changed from $OLD_VERSION to $NEW_VERSION - will release"
            else
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ package.json changed but version unchanged - skipping release"
            fi
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ package.json not changed - skipping release"
          fi

  build:
    name: å»ºæ§‹å°ˆæ¡ˆ
    needs: check-version
    if: needs.check-version.outputs.should-release == 'true' && needs.check-version.outputs.tag-exists == 'false'
    uses: ./.github/workflows/build-job.yml

  package:
    name: æ‰“åŒ…ç™¼å¸ƒç‰ˆæœ¬
    needs: [check-version, build]
    if: needs.check-version.outputs.should-release == 'true' && needs.check-version.outputs.tag-exists == 'false'
    uses: ./.github/workflows/package-job.yml
    with:
      version: ${{ needs.check-version.outputs.version }}
      upload-artifact: true
      artifact-name: pangu2-${{ needs.check-version.outputs.version }}-release

  release:
    name: ç™¼å¸ƒåˆ° GitHub å’Œ Marketplace
    needs: [check-version, build, package]
    if: needs.check-version.outputs.should-release == 'true' && needs.check-version.outputs.tag-exists == 'false'
    runs-on: ubuntu-latest

    steps:
      - name: ç°½å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ä¸‹è¼‰ VSIX æª”æ¡ˆ
        uses: actions/download-artifact@v4
        with:
          name: pangu2-${{ needs.check-version.outputs.version }}-release

      - name: å»ºç«‹æ¨™ç±¤
        run: |
          TAG_NAME="v${{ needs.check-version.outputs.version }}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"

      - name: å»ºç«‹ GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: ç›¤å¤ä¹‹ç™½ v${{ needs.check-version.outputs.version }}
          tag_name: v${{ needs.check-version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: pangu2-${{ needs.check-version.outputs.version }}.vsix

      - name: ç™¼å¸ƒåˆ° VS Code Marketplace
        run: npx -y @vscode/vsce publish --packagePath pangu2-${{ needs.check-version.outputs.version }}.vsix
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
