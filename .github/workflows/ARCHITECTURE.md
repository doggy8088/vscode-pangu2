# GitHub Actions Workflow æ¶æ§‹åœ–

## æ•´é«”æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GitHub Actions Workflows                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                           â”‚
                â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å¯é‡ç”¨ Workflows  â”‚       â”‚   ä¸»è¦ Workflows  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚          â”‚                â”‚
    â–¼                â–¼          â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ build-  â”‚   â”‚ package- â”‚  â”‚ ci.yml â”‚    â”‚ release. â”‚
â”‚ job.yml â”‚   â”‚ job.yml  â”‚  â”‚        â”‚    â”‚ yml      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## CI Workflow æµç¨‹åœ–

### Pull Request è§¸ç™¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PR Event   â”‚
â”‚  (opened,    â”‚
â”‚  sync, etc)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Job 1: build        â”‚
â”‚  (build-job.yml)     â”‚
â”‚                      â”‚
â”‚  â€¢ ç°½å‡ºç¨‹å¼ç¢¼         â”‚
â”‚  â€¢ å®‰è£ç›¸ä¾å¥—ä»¶       â”‚
â”‚  â€¢ å»ºæ§‹å°ˆæ¡ˆ          â”‚
â”‚  â€¢ ä¸Šå‚³å»ºæ§‹ç”¢ç‰©       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ outputs: version
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Job 2: package      â”‚
â”‚  (package-job.yml)   â”‚
â”‚                      â”‚
â”‚  â€¢ ä¸‹è¼‰å»ºæ§‹ç”¢ç‰©       â”‚
â”‚  â€¢ æ‰“åŒ… VSIX         â”‚
â”‚  â€¢ âœ… ä¸Šå‚³ artifact  â”‚
â”‚    (pangu2-v-prN)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Job 3: pr-comment   â”‚
â”‚                      â”‚
â”‚  â€¢ ä¸‹è¼‰ VSIX         â”‚
â”‚  â€¢ å–å¾—æª”æ¡ˆå¤§å°       â”‚
â”‚  â€¢ ğŸ“ åœ¨ PR ç•™è¨€     â”‚
â”‚  â€¢ æä¾›ä¸‹è¼‰é€£çµ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Main Branch Push è§¸ç™¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Push Event  â”‚
â”‚  (to main)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Job 1: build        â”‚
â”‚  (build-job.yml)     â”‚
â”‚                      â”‚
â”‚  â€¢ ç°½å‡ºç¨‹å¼ç¢¼         â”‚
â”‚  â€¢ å®‰è£ç›¸ä¾å¥—ä»¶       â”‚
â”‚  â€¢ å»ºæ§‹å°ˆæ¡ˆ          â”‚
â”‚  â€¢ ä¸Šå‚³å»ºæ§‹ç”¢ç‰©       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ outputs: version
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Job 2: package      â”‚
â”‚  (package-job.yml)   â”‚
â”‚                      â”‚
â”‚  â€¢ ä¸‹è¼‰å»ºæ§‹ç”¢ç‰©       â”‚
â”‚  â€¢ æ‰“åŒ… VSIX         â”‚
â”‚  â€¢ âŒ ä¸ä¸Šå‚³ artifactâ”‚
â”‚    (åƒ…æ¸¬è©¦æ‰“åŒ…)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚
       â–¼ (skip)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Job 3: pr-comment   â”‚
â”‚  (skipped)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Release Workflow æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Trigger Events:     â”‚
â”‚  â€¢ Push to main +    â”‚
â”‚    package.json è®Šæ›´  â”‚
â”‚  â€¢ Manual dispatch   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Job 1: check-version    â”‚
â”‚                          â”‚
â”‚  â€¢ è®€å–ç‰ˆæœ¬è™Ÿ             â”‚
â”‚  â€¢ æª¢æŸ¥ tag æ˜¯å¦å­˜åœ¨      â”‚
â”‚  â€¢ æª¢æŸ¥ç‰ˆæœ¬æ˜¯å¦è®Šæ›´       â”‚
â”‚  â€¢ æ±ºå®šæ˜¯å¦ç™¼å¸ƒ           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ outputs:
       â”‚ â€¢ should-release
       â”‚ â€¢ version
       â”‚ â€¢ tag-exists
       â”‚
       â–¼
      â”Œâ”€â”´â”€â”
      â”‚ ? â”‚ should-release == true
      â””â”€â”¬â”€â”˜ && tag-exists == false
        â”‚
        â”‚ YES
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Job 2: build        â”‚
â”‚  (build-job.yml)     â”‚
â”‚                      â”‚
â”‚  â€¢ ç°½å‡ºç¨‹å¼ç¢¼         â”‚
â”‚  â€¢ å®‰è£ç›¸ä¾å¥—ä»¶       â”‚
â”‚  â€¢ å»ºæ§‹å°ˆæ¡ˆ          â”‚
â”‚  â€¢ ä¸Šå‚³å»ºæ§‹ç”¢ç‰©       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Job 3: package      â”‚
â”‚  (package-job.yml)   â”‚
â”‚                      â”‚
â”‚  â€¢ ä¸‹è¼‰å»ºæ§‹ç”¢ç‰©       â”‚
â”‚  â€¢ æ‰“åŒ… VSIX         â”‚
â”‚  â€¢ âœ… ä¸Šå‚³ artifact  â”‚
â”‚    (release)         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Job 4: release      â”‚
â”‚                      â”‚
â”‚  â€¢ ä¸‹è¼‰ VSIX         â”‚
â”‚  â€¢ ğŸ·ï¸ å»ºç«‹ Git tag   â”‚
â”‚  â€¢ ğŸ“¦ å»ºç«‹ Release   â”‚
â”‚  â€¢ ğŸš€ ç™¼å¸ƒåˆ°         â”‚
â”‚    Marketplace       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¯é‡ç”¨ Workflows è©³ç´°èªªæ˜

### build-job.yml

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         build-job.yml              â”‚
â”‚   (Reusable Workflow)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚
â”‚  Inputs:  (none)                   â”‚
â”‚                                    â”‚
â”‚  Outputs:                          â”‚
â”‚    â€¢ version: å°ˆæ¡ˆç‰ˆæœ¬è™Ÿ            â”‚
â”‚                                    â”‚
â”‚  Permissions:                      â”‚
â”‚    â€¢ contents: read                â”‚
â”‚                                    â”‚
â”‚  Steps:                            â”‚
â”‚    1. ç°½å‡ºç¨‹å¼ç¢¼                    â”‚
â”‚    2. è¨­å®š Node.js 20              â”‚
â”‚    3. å®‰è£ç›¸ä¾å¥—ä»¶ (npm ci)         â”‚
â”‚    4. è®€å–ç‰ˆæœ¬è™Ÿ                    â”‚
â”‚    5. å»ºæ§‹å°ˆæ¡ˆ (npm run esbuild)   â”‚
â”‚    6. ä¸Šå‚³å»ºæ§‹ç”¢ç‰©                  â”‚
â”‚       (out/, package.json, etc)    â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### package-job.yml

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        package-job.yml             â”‚
â”‚   (Reusable Workflow)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚
â”‚  Inputs:                           â”‚
â”‚    â€¢ version (required)            â”‚
â”‚    â€¢ upload-artifact (optional)    â”‚
â”‚    â€¢ artifact-name (optional)      â”‚
â”‚                                    â”‚
â”‚  Permissions:                      â”‚
â”‚    â€¢ contents: read                â”‚
â”‚                                    â”‚
â”‚  Steps:                            â”‚
â”‚    1. ç°½å‡ºç¨‹å¼ç¢¼                    â”‚
â”‚    2. è¨­å®š Node.js 20              â”‚
â”‚    3. ä¸‹è¼‰å»ºæ§‹ç”¢ç‰©                  â”‚
â”‚    4. æ‰“åŒ… VSIX (vsce package)     â”‚
â”‚    5. æ¢ä»¶å¼ä¸Šå‚³ VSIX              â”‚
â”‚       (if upload-artifact == true) â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è§¸ç™¼æ¢ä»¶çŸ©é™£

| Event | ci.yml | release.yml | èªªæ˜ |
|-------|--------|-------------|------|
| PR opened/sync | âœ… | âŒ | CI å»ºç½®ä¸¦åœ¨ PR ç•™è¨€ |
| Push to main (ç„¡ package.json è®Šæ›´) | âœ… | âŒ | åƒ… CI æ¸¬è©¦ |
| Push to main (æœ‰ package.json è®Šæ›´ä½†ç‰ˆæœ¬æœªè®Š) | âœ… | âŒ | åƒ… CI æ¸¬è©¦ |
| Push to main (package.json ç‰ˆæœ¬è®Šæ›´) | âœ… | âœ… | CI æ¸¬è©¦ + è‡ªå‹•ç™¼å¸ƒ |
| Manual workflow_dispatch | âŒ | âœ… | æ‰‹å‹•è§¸ç™¼ç™¼å¸ƒ |

## Artifact å‘½åè¦å‰‡

| Context | Artifact Name | ç¯„ä¾‹ |
|---------|--------------|------|
| PR Build | `pangu2-{version}-pr{number}` | `pangu2-1.4.1-pr42` |
| Main Push (test) | `pangu2-test` | `pangu2-test` |
| Release Build | `pangu2-{version}-release` | `pangu2-1.4.1-release` |

## æ¬Šé™è¨­å®š

| Workflow | Job | Permissions |
|----------|-----|-------------|
| build-job.yml | build | `contents: read` |
| package-job.yml | package | `contents: read` |
| ci.yml | (workflow level) | `contents: read`, `pull-requests: write` |
| release.yml | (workflow level) | `contents: write` |

## å®‰å…¨ç‰¹æ€§

âœ… **æœ€å°æ¬Šé™åŸå‰‡**
- æ‰€æœ‰ jobs éƒ½æ˜ç¢ºè¨­å®šæ¬Šé™
- å¯é‡ç”¨ workflows åƒ…éœ€ `contents: read`
- Release workflow åƒ…åœ¨å¿…è¦æ™‚ä½¿ç”¨ `contents: write`

âœ… **ç‰ˆæœ¬æ§åˆ¶**
- Release åªåœ¨ç‰ˆæœ¬çœŸçš„è®Šæ›´æ™‚åŸ·è¡Œ
- é˜²æ­¢é‡è¤‡ç™¼å¸ƒåŒä¸€ç‰ˆæœ¬
- è‡ªå‹•æª¢æŸ¥ Git tag æ˜¯å¦å­˜åœ¨

âœ… **Artifact å®‰å…¨**
- PR artifacts æœ‰æ˜ç¢ºçš„å‘½åè¦å‰‡
- Retention è¨­å®šç‚º 30 å¤©ï¼ˆPRï¼‰æˆ– 1 å¤©ï¼ˆå…§éƒ¨å‚³éï¼‰
- ä¸æœƒä¸Šå‚³æ•æ„Ÿè³‡æ–™

## ç¶­è­·å»ºè­°

### ä¿®æ”¹å»ºæ§‹é‚è¼¯
â¡ï¸ ç·¨è¼¯ `build-job.yml`

### ä¿®æ”¹æ‰“åŒ…é‚è¼¯
â¡ï¸ ç·¨è¼¯ `package-job.yml`

### ä¿®æ”¹ PR ç•™è¨€å…§å®¹
â¡ï¸ ç·¨è¼¯ `ci.yml` çš„ `pr-comment` job

### ä¿®æ”¹ç™¼å¸ƒé‚è¼¯
â¡ï¸ ç·¨è¼¯ `release.yml` çš„ `release` job

### ä¿®æ”¹è§¸ç™¼æ¢ä»¶
â¡ï¸ ç·¨è¼¯å°æ‡‰ workflow çš„ `on:` å€å¡Š
